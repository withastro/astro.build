---
import type { HTMLAttributes } from "astro/types"
import { getImage } from "astro:assets"
import type { RequireSome } from "~/types/utils.js"
export type Props = RequireSome<Omit<HTMLAttributes<"img">, "src">, "alt"> & {
  src: ImageMetadata
  widths: number[]
}
const { src, alt, widths, ...attrs } = Astro.props
const sources = await Promise.all(
  widths.map((width) =>
    getImage({
      src,
      width,
      format: "webp",
      alt,
    }),
  ),
)
const srcset = sources.map((metadata, i) => `${metadata.src} ${widths[i]}w`).join(", ")
const fallback = sources[0]
---

<img src={fallback.src} srcset={srcset} {...fallback.attributes} {...attrs} />
