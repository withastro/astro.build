---
title: 'Astro 5.6'
description: 'Astro 5.6 brings first class astro:env and experimental session support to Cloudflare, and gives more control over prefetching.'
homepageLink:
  title: 'Astro 5.6'
  subtitle: 'Available now!'
publishDate: '2025-04-03'
authors:
  - matt
coverImage: '/src/content/blog/_images/astro-560/blog-post-5-6.webp'
socialImage: '/src/content/blog/_images/astro-560/og-astro-5-6.webp'
lang: 'en'
---

import BlogContentImage from '/src/components/BlogContentImage.astro';
import Mention from '/src/components/Mention.astro';

**Astro 5.6 brings first class astro:env and experimental session support to Cloudflare, and gives more control over prefetching.**

☁️ Soar through the clouds with these new features in Astro:

- [**Global `astro:env` on Cloudflare**](#global-astroenv-on-cloudflare)
- [**Experimental sessions on Cloudflare**](#experimental-sessions-on-cloudflare)
- [**New prefetch eagerness option**](#new-prefetch-eagerness-option)
- [**Custom fetch option for prerendered error pages**](#custom-fetch-option-for-prerendered-error-pages)
- [**Improved config validation**](#improved-config-validation)

To upgrade an existing project, use the automated `@astrojs/upgrade` CLI tool. Alternatively, upgrade manually by running the upgrade command for your package manager:

```sh
# Recommended:
npx @astrojs/upgrade

# Manual:
npm install astro@latest
pnpm upgrade astro --latest
yarn upgrade astro --latest
```

## Global `astro:env` on Cloudflare

Since Astro 5 you have been able to access [type-safe environment variables using `astro:env`](https://docs.astro.build/en/guides/environment-variables/#type-safe-environment-variables). However, environment variables in Cloudflare were only accessible within a request — limiting when and where you could use them. For example, if you wanted to use a shared API client instance you couldn't use environment variables if instantiating outside of a request. This could be confusing, and was different from our other adapters.

Astro 5.6 lifts this restriction, meaning you can now access your environment variables globally throughout your server code and brings the Cloudflare adapter in line with the other official adapters. This is possible thanks to [enhancements in Cloudflare Workers](https://developers.cloudflare.com/changelog/2025-03-17-importable-env/) that are now implemented in Astro.

```js
import { defineMiddleware } from 'astro:middleware';
import { API_URL } from 'astro:env/server';
import { createClient } from './client.js';

// Astro 5.5: undefined
// Astro 5.6: string
const client = createClient(API_URL);

export const onRequest = defineMiddleware((ctx, next) => {
	ctx.locals.client = client;
	return next();
});
```

This improvement creates a more consistent developer experience across all Astro server environments.

## Experimental sessions on Cloudflare

The [Astro sessions API](https://docs.astro.build/en/reference/experimental-flags/sessions/) is an experimental feature that allows you to easily store user data between requests. It uses pluggable backends for storage, which are automatically configured when using the Node or Netlify adapters.

With Astro 5.6, we've brought that simplified integration to Cloudflare, too. Astro now automatically configures Cloudflare KV storage when you're using sessions with the Cloudflare adapter. This means your session data can be reliably stored and accessed across Cloudflare's global network with minimal configuration.

Getting started is three steps:

1. Create a KV namespace using the Wrangler CLI:

```sh
npx wrangler kv namespace create "SESSION"
```

2. Declare the KV namespace in your Wrangler config:

```jsonc
// wrangler.json
{
	"kv_namespaces": [
		{
			"binding": "SESSION",
			"id": "<SESSION_ID>"
		}
	]
}
```

3. Enable experimental sessions in your Astro config:

```js
// astro.config.mjs
export default defineConfig({
	adapter: cloudflare(),
	experimental: {
		sessions: true,
	},
});
```

You can then use sessions in your server code:

```astro
---
export const prerender = false;
const cart = await Astro.session.get('cart');
---

<a href="/checkout">🛒 {cart?.length ?? 0} items</a>
```

For more information, see the [experimental sessions docs](https://docs.astro.build/en/reference/experimental-flags/sessions/).

## New Prefetch Eagerness Option

Find the perfect balance between speed and resource usage with Astro's new prefetch eagerness controls. With the experimental [`clientPrerender`](https://docs.astro.build/en/reference/experimental-flags/client-prerender/) flag enabled, you can use the `eagerness` option on `prefetch()` to suggest to the browser how eagerly it should prefetch/prerender link targets.

This new option, which aligns with the browser's [Speculation Rules API](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script/type/speculationrules), gives you fine-grained control over how aggressively the browser should prefetch or prerender your links:

```astro
---
---
<script>
// Control prefetching eagerness
import { prefetch } from 'astro:prefetch';

// Let's be strategic about this resource-intensive page
prefetch('/data-heavy-dashboard', { eagerness: 'conservative' });

// This page is critical to the user journey, load it ASAP!
prefetch('/product-details', { eagerness: 'immediate' });

// For most pages, a balanced approach works best
prefetch('/about', { eagerness: 'moderate' });
</script>
```

You can choose from three eagerness levels:

- `'immediate'`: Prefetch immediately, if resource limits allow
- `'eager'`: Link is likely to be needed, so fetch at the earliest opportunity
- `'moderate'`: Let the browser decide when to prefetch
- `'conservative'`: Only prefetch when highly likely to be needed

This feature is particularly valuable when dealing with large numbers of links where you might otherwise run into [browser limits in place to guard against over-speculating](https://developer.chrome.com/blog/speculation-rules-improvements#chrome-limits).

Thanks to community member [Marocco2](https://github.com/Marocco2) for contributing this feature!

## Custom Fetch Option for Prerendered Error Pages

When an on-demand rendered page needs to display an error, it may need to fetch the prerendered error page from elsewhere. Currently, this is done by making a request using the default `fetch` implementation, which may not be suitable for all use cases. For example, the page may be served from a location that can't be called recursively, or the page may be stored elsewhere. Astro 5.6 adds a new optional `prerenderedErrorPageFetch` option in the Adapter API to allow adapters to provide custom implementations for fetching prerendered error pages.

The following example provides a custom fetch for `500.html` and `404.html`, reading them from disk instead of performing an HTTP call:
```js 
return app.render(request, {
  prerenderedErrorPageFetch: async (url: string): Promise<Response> => {
    if (url.includes("/500")) {
        const content = await fs.promises.readFile("500.html", "utf-8");
        return new Response(content, {
          status: 500,
          headers: { "Content-Type": "text/html" },
        });
    }
    const content = await fs.promises.readFile("404.html", "utf-8");
      return new Response(content, {
        status: 404,
        headers: { "Content-Type": "text/html" },
      });
});
```
If no value is provided, Astro will use `fetch`, and make a request to `/500` or `/404` as appropriate. This is the same behavior as in previous versions of Astro.

Read more about this feature in the [Adapter API reference](https://docs.astro.build/en/reference/adapter-reference/#prerenderederrorpagefetch).

Thanks to [Yury Michurin](https://github.com/yurynix) for contributing this feature!

## Improved Config Validation

Astro now validates your config after every integration is run, making it easier to catch issues early and pinpoint the source of any problems. This is particularly useful when using multiple integrations, as it helps ensure that they are all compatible with each other and with your Astro project.

## Bug fixes

As always, we've been working hard on fixing issues since the [5.5 release](/blog/astro-550). See [the changelog](https://github.com/withastro/astro/blob/main/packages/astro/CHANGELOG.md) for all the details.

## Community

The Astro core team is:

<Mention name="ben" />, <Mention name="caleb" />, <Mention name="chris" />, <Mention name="ema" />, <Mention name="erika" />, <Mention name="florian" />, <Mention name="fuzzy" />, <Mention name="hideoo" />, <Mention name="luiz" />, <Mention name="matt" />, <Mention name="matthew" />, <Mention name="nate" />, <Mention name="reuben" />, <Mention name="sarah" />, and <Mention name="yan" />.

Thanks to all the other contributors who helped make Astro 5.6 possible, including [Edward Brunetiere](https://github.com/P4tt4te), [Martin Trapp](https://github.com/martrapp), [Vardhaman Bhandari](https://github.com/Vardhaman619), [Marocco2](https://github.com/Marocco2) and [Yury Michurin](https://github.com/yurynix).

We look forward to seeing what you build with Astro 5.6! If you have questions, comments, or just want to say hi, drop by the [Astro Discord](https://astro.build/chat).

import RelatedPosts from './_components/RelatedPosts.astro';

<RelatedPosts slugs={['astro-550', 'astro-540']} />
