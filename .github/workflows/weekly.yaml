name: Weekly

on:
  schedule:
    - cron: "0 12 * * Mon"
  workflow_dispatch:

jobs:
  integrations:
    name: Update Integrations
    if: github.repository_owner == 'withastro'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code using Git
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js & install dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dev dependencies
        run: pnpm install

      - name: Search NPM for new and deprecated integrations
        run: pnpm run update:integrations --unsafe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format generated files
        run: pnpm run format

      - name: Create Pull Request
        id: createpr
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          branch: ci/docgen-integrations
          token: ${{ secrets.FREDKBOT_GITHUB_TOKEN }}
          author: Houston (Bot) <108291165+astrobot-houston@users.noreply.github.com>
          add-paths: src/content/**/*.md
          commit-message: "ci: update integrations"
          title: "ci: update integrations"
          body: |
            This PR is auto-generated by a GitHub action that runs every Monday to update the integrations catalog with data from GitHub and NPM.
          labels: ci

  showcase:
    name: Update Showcase Sites
    if: github.repository_owner == 'withastro'
    # Puppeteer is breaking with ubuntu-24.04, so weâ€™re still using 22 for this workflow
    runs-on: ubuntu-22.04
    steps:
      - name: Check out code using Git
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Tools & Dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dev dependencies
        run: pnpm install

      - name: Run update:showcase script
        id: showcase
        run: pnpm run update:showcase
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format generated files
        run: pnpm run format

      - name: Create Pull Request
        id: createpr
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          branch: ci/docgen-showcase
          token: ${{ secrets.FREDKBOT_GITHUB_TOKEN }}
          author: Houston (Bot) <108291165+astrobot-houston@users.noreply.github.com>
          add-paths: src/content/**/*.yml,src/content/**/*.webp
          commit-message: "ci: update showcase"
          title: "ci: update showcase"
          body: ${{ steps.showcase.outputs.prBody }}
          labels: ci

  stats:
    name: Update Stats
    if: github.repository_owner == 'withastro'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code using Git
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Tools & Dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dev dependencies
        run: pnpm install

      - name: Run update:stats script
        run: pnpm run update:stats
        env:
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}

      - name: Create Pull Request
        id: createpr
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          branch: ci/docgen-stats
          token: ${{ secrets.FREDKBOT_GITHUB_TOKEN }}
          author: Houston (Bot) <108291165+astrobot-houston@users.noreply.github.com>
          add-paths: src/data/stats.json
          commit-message: "ci: update stats"
          title: "ci: update stats"
          body: |
            This PR is auto-generated by a GitHub action that runs every Monday to update stats about Astro.
          labels: ci
